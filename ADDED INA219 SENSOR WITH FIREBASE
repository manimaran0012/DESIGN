#include <Wire.h>
#include <WiFi.h>
#include <Firebase.h>
#include <Adafruit_INA219.h>

// ==============================
// ðŸ”¹ Firebase Database URL
// ==============================
#define FIREBASE_URL "https://solarproject-92dff-default-rtdb.firebaseio.com/"
Firebase fb(FIREBASE_URL);

// ==============================
// ðŸ”¹ Wi-Fi Credentials
// ==============================
const char* ssids[] = {"Infinix HOT 30 5G", "Galaxy F6292c9", "DESKTOP-LA7NV8S 3011"};
const char* passwords[] = {"mani00122", "dxwm3987", "manimaran"};
const int WIFI_COUNT = 3;

// ==============================
// ðŸ”¹ Relay Pins (LOW-level trigger)
// ==============================
#define RELAY1 25  // FAN
#define RELAY2 26  // LIGHT1
#define RELAY3 27  // LIGHT2

// ==============================
// ðŸ”¹ INA219 (I2C) Connections
// ==============================
// ESP32 â†’ INA219
// 3.3V  â†’ VCC
// GND   â†’ GND
// GPIO21 â†’ SDA
// GPIO22 â†’ SCL
Adafruit_INA219 ina219;

// ==============================
// ðŸ”¹ Timers
// ==============================
unsigned long previousMillis = 0;
unsigned long sensorMillis = 0;
const long firebaseInterval = 500;   // Relay update every 0.5s
const long sensorInterval = 2000;    // Sensor upload every 2s

// =============================================================
// ðŸ”¹ SETUP
// =============================================================
void setup() {
  Serial.begin(115200);
  Wire.begin(21, 22);  // SDA, SCL

  connectToWiFi();

  pinMode(RELAY1, OUTPUT);
  pinMode(RELAY2, OUTPUT);
  pinMode(RELAY3, OUTPUT);

  if (!ina219.begin()) {
    Serial.println("âŒ INA219 not found! Check wiring!");
    while (1);
  }

  ina219.setCalibration_32V_2A();
  Serial.println("âœ… Setup Complete! Monitoring started...");
}

// =============================================================
// ðŸ”¹ LOOP
// =============================================================
void loop() {
  unsigned long currentMillis = millis();

  // --- Read relays from Firebase ---
  if (currentMillis - previousMillis >= firebaseInterval) {
    previousMillis = currentMillis;
    updateRelaysFromFirebase();
  }

  // --- Read INA219 sensor and upload ---
  if (currentMillis - sensorMillis >= sensorInterval) {
    sensorMillis = currentMillis;
    readAndUploadINA219();
  }
}

// =============================================================
// ðŸ”¹ FUNCTION: Update Relays Based on Firebase Data
// =============================================================
void updateRelaysFromFirebase() {
  String fan = "", light1 = "", light2 = "";

  if (fb.getString("SOLAR_HOME_AUTOMATION/FAN", fan) &&
      fb.getString("SOLAR_HOME_AUTOMATION/LIGHT1", light1) &&
      fb.getString("SOLAR_HOME_AUTOMATION/LIGHT2", light2)) {

    fan.trim(); fan.replace("\"", "");
    light1.trim(); light1.replace("\"", "");
    light2.trim(); light2.replace("\"", "");

    Serial.printf("FIREBASE -> FAN:%s | LIGHT1:%s | LIGHT2:%s\n",
                  fan.c_str(), light1.c_str(), light2.c_str());

    // Control relays (LOW-level trigger)
    digitalWrite(RELAY1, fan.equalsIgnoreCase("true") ? LOW : HIGH);
    digitalWrite(RELAY2, light1.equalsIgnoreCase("true") ? LOW : HIGH);
    digitalWrite(RELAY3, light2.equalsIgnoreCase("true") ? LOW : HIGH);
  } else {
    Serial.println("âš ï¸ Failed to read Firebase control data!");
  }
}

// =============================================================
// ðŸ”¹ FUNCTION: Read INA219 Data and Upload to Firebase
// =============================================================
void readAndUploadINA219() {
  float busVoltage = ina219.getBusVoltage_V();      // V
  float current_mA = ina219.getCurrent_mA();        // mA
  float power_mW = ina219.getPower_mW();            // mW

  float current_A = current_mA / 1000.0;            // Convert to A
  float power_W = power_mW / 1000.0;                // Convert to W

  // Battery % for 3S Li-ion (12.6V full, 9.6V empty)
  float percent = (busVoltage - 9.6) * 100 / (12.6 - 9.6);
  if (percent > 100) percent = 100;
  if (percent < 0) percent = 0;

  // ðŸ”¸ PRINT VALUES (IN UPPERCASE FORMAT)
  Serial.println("------------------------------------------");
  Serial.printf("VOLTAGE : %.2f V\n", busVoltage);
  Serial.printf("CURRENT : %.3f A\n", current_A);
  Serial.printf("POWER : %.3f W\n", power_W);
  Serial.printf("BATTERY_PERCENTAGE : %.1f %%\n", percent);
  Serial.println("------------------------------------------\n");

  // ðŸ”¸ SEND TO FIREBASE
  fb.setFloat("SOLAR_HOME_AUTOMATION/VOLTAGE", busVoltage);
  fb.setFloat("SOLAR_HOME_AUTOMATION/CURRENT", current_A);
  fb.setFloat("SOLAR_HOME_AUTOMATION/POWER", power_W);
  fb.setFloat("SOLAR_HOME_AUTOMATION/BATTERY_PERCENTAGE", percent);
}

// =============================================================
// ðŸ”¹ FUNCTION: Connect to Wi-Fi Automatically
// =============================================================
void connectToWiFi() {
  Serial.println("Scanning Wi-Fi...");
  int n = WiFi.scanNetworks();
  if (n == 0) {
    Serial.println("âš ï¸ No networks found!");
    return;
  }

  for (int i = 0; i < WIFI_COUNT; i++) {
    for (int j = 0; j < n; j++) {
      if (String(WiFi.SSID(j)) == ssids[i]) {
        Serial.print("Connecting to "); Serial.println(ssids[i]);
        WiFi.begin(ssids[i], passwords[i]);
        int attempts = 0;
        while (WiFi.status() != WL_CONNECTED && attempts < 20) {
          delay(500);
          Serial.print(".");
          attempts++;
        }
        if (WiFi.status() == WL_CONNECTED) {
          Serial.println("\nâœ… Wi-Fi Connected! IP: " + WiFi.localIP().toString());
          return;
        } else {
          Serial.println("\nFailed to connect, trying next...");
        }
      }
    }
  }
  Serial.println("âš ï¸ No known Wi-Fi found.");
}
